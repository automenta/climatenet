<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="jquery-2.1.1.min.js"></script>
        <script src="lodash.min.js"></script>

        <!-- http://leafletjs.com/examples/quick-start.html -->
        <script src="leaflet/leaflet.js"></script>        
        <link rel="stylesheet" href="leaflet/leaflet.css">

    </head>
    <body>
        <style>
            #map { height: 500px; }
        </style>
        <div id="map"></div>
        <script>

            var updatePeriodMS = 500;

            var map = L.map('map').setView([51.505, -0.09], 13);

            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
                attribution: 'attribute this :P mothrefuckers',
                maxZoom: 18
            }).addTo(map);

            var geojsonMarkerOptions = {
                radius: 8,
                fillColor: "#ff7800",
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            };

            var gj = L.geoJson().addTo(map);

            //not used yet:
            var geojsonoption = {
                onEachFeature: function onEachFeature(feature, layer) {
                    // does this feature have a property named popupContent?
                    if (feature.properties && feature.properties.popupContent) {
                        layer.bindPopup(feature.properties.popupContent);
                    }
                },
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, geojsonMarkerOptions);
                }
            };
            

            function updateGeoJSONFeatures(r) {
                
                gj.clearLayers();
                for (var i = 0; i < r.length; i++) {
                    var f = r[i];
                    f.type = "Feature";
                    f.geometry = f.geom;
                    if (f.geom.type === "point")
                        f.geometry.type = "Point";
                    gj.addData(f);
                }
            }

            var updateBounds = _.throttle(function (e) {
                var b = map.getBounds();

                var radiusMeters = b.getSouthEast().distanceTo(b.getNorthWest());
                var lon = b.getCenter().lng;
                var lat = b.getCenter().lat;


                $.getJSON('/geoCircle', {lat: lat, lon: lon, radiusM: radiusMeters})

                        .done(function (r) {
                            //console.log('received');
                            //console.log(r);

                            updateGeoJSONFeatures(r);
                        })
                        .fail(function (v, m) {
                            console.log('err', v, m);
                        });
            });

            map.on('viewreset', updateBounds);
            map.on('move', updateBounds);
            map.on('resize', updateBounds);

            updateBounds();
        </script>

    </body>
</html>

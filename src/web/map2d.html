<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>ClimateNet</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="lib/es6-shim.min.js"></script>
        <script src="lib/jquery-2.1.1.min.js"></script>
        <script src="lib/lodash.min.js"></script>
        <script src="lib/graphlib.min.js"></script>

        <script src="lib/bootstrap/js/bootstrap.min.js"></script>
        <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="lib/bootswatch/bootstrap.cyborg.min.css">

        <link rel="stylesheet" href="lib/fontawesome/css/font-awesome.min.css">

        <!-- http://leafletjs.com/examples/quick-start.html -->
        <script src="lib/leaflet/leaflet.js"></script>        
        <script src="lib/leaflet/leaflet.osmgeocoder.js"></script>   
        <script src="lib/leaflet/leaflet.markercluster.js"></script>
        <script src="lib/leaflet/leaflet-providers.js"></script>
        <script src="lib/leaflet/leaflet.geojsoncss.min.js"></script>
        <link rel="stylesheet" href="lib/leaflet/leaflet.css">
        <link rel="stylesheet" href="lib/leaflet/leaflet.osmgeocoder.css">
        <link rel="stylesheet" href="lib/leaflet/MarkerCluster.css">
        
        <script src="lib/pnotify/pnotify.custom.min.js"></script>
        <link type="text/css" rel="stylesheet" href="lib/pnotify/pnotify.custom.min.css"/>

        

        <!--
        <script src="lib/d3/d3.min.js"></script>    
        <script src="lib/zoomtree.js"></script>        
        <link rel="stylesheet" href="lib/zoomtree.css">
        -->
        
        <link rel="stylesheet" href="map2d.css">
        
        <script src="util.js"></script>

    </head>
    <body>

        <div id="map"></div>


        <div id="wrapper" class="active">

            <!-- Sidebar -->
            <div id="sidebar-wrapper">
                <ul id="sidebar_menu" class="sidebar-nav">
                    <li class="sidebar-brand">
                        <div style="float: left">
                            <input placeholder="Find.." class="sidebar_search" type="text"></input>
                        </div>
                        <div style="right:0; position:absolute"><a id="menu-toggle" href="#"><i class="main_icon fa fa-bomb fa-2x"></i></a></div>
                    </li>
                </ul>
                <ul class="sidebar-nav" id="visibleLayers">     
                    <!--<li><a>Link1<i class="sub_icon fa fa-bolt fa-2x"></i></a></li>
                    <li><a>link2<i class="sub_icon fa fa-cloud fa-2x"></i></a></li>-->
                </ul>

            </div>

            <!-- Page content -->
            <div id="page-content-wrapper">
            </div>

        </div>


        <!--

        <nav class="navbar navbar-inverse">
            <div class="container-fluid">             

                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                        <li class="active"><a href="#">Link <span class="sr-only">(current)</span></a></li>
                        <li><a href="#">Link</a></li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Dropdown <span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#">Action</a></li>
                                <li><a href="#">Another action</a></li>
                                <li><a href="#">Something else here</a></li>
                                <li class="divider"></li>
                                <li><a href="#">Separated link</a></li>
                                <li class="divider"></li>
                                <li><a href="#">One more separated link</a></li>
                            </ul>
                        </li>
                    </ul>
                    <form class="navbar-form navbar-left" role="search">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search">
                        </div>
                    </form>
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="#">Link</a></li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Dropdown <span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#">Action</a></li>
                                <li><a href="#">Another action</a></li>
                                <li><a href="#">Something else here</a></li>
                                <li class="divider"></li>
                                <li><a href="#">Separated link</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        -->


        <!--<div id="layermenu" class="panel panel-default"></div>-->

        <script>
            

            var updatePeriodMS = 200;
            var renderPeriodMS = 50;

            var features = {};
            var tag = new graphlib.Graph({multigraph: true}); //https://github.com/cpettitt/graphlib/wiki
            var tagOpacity = { };

            function addTileLayer(id, name, parent) {
                var t = newTag(id);
                t.name = name;
                t.inh[parent] = 1.0;
                t.tileLayer = true;
                t.update();
            }
            
            function addTileLayers() {
                var w = newTag('Weather');
                w.name = 'Weather';
                
                //https://github.com/leaflet-extras/leaflet-providers/blob/master/leaflet-providers.js
                addTileLayer('OpenWeatherMap.Temperature', 'Temperature (OWM)', 'Weather');
                addTileLayer('OpenWeatherMap.Clouds', 'Clouds (OWM)', 'Weather');
                                
                addTileLayer('OpenStreetMap.Mapnik', 'OpenStreetMap', 'Earth');
                addTileLayer('OpenStreetMap.BlackAndWhite', 'OpenStreetMap (Gray)', 'Earth');
                
                addTileLayer('Thunderforest.Landscape', 'Landscape (Thunderforest)', 'Earth');
                
            }
            
            
            var geojsonMarkerOptions = {
                radius: 8,
                fillColor: "#ff7800",
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            };


            var map = L.map('map');
                    
            map.setView([51.505, -0.09], 13);
            
            var osmGeocoder = new L.Control.OSMGeocoder();
            map.addControl(osmGeocoder);
                
            var ltree;
            function init() {
                
                $("#menu-toggle").click(function(e) {
                        e.preventDefault();
                        $("#wrapper").toggleClass("active");
                });

                //Default: OSM layer
                tagOpacity['OpenStreetMap.Mapnik'] = 1.0;



                map.on('viewreset', updateBounds);
                map.on('move', updateBounds);
                map.on('resize', updateBounds);

                addTileLayers();
                
                updateTagIndex(renderLayerViews);

                updateBounds();                
                
                setTimeout(renderTags, 0);
            }

            var renderTags = _.throttle(function() {
                
                map.eachLayer(function (layer) {
                   layer.remove(); 
                });
                
                _.each(tagOpacity, function(opacity, tagID) {
                    if (opacity === 0) return;
                    
                    var t = tag.node(tagID);
                    if (t.tileLayer) {
                        var l = L.tileLayer.provider(tagID);
                        l.setOpacity(opacity);
                        l.addTo(map);
                    }
                   
                   //var markers = new L.MarkerClusterGroup();
                   //markers.addLayer(new L.Marker(getRandomLatLng(map)));
                });
            }, renderPeriodMS);

            /*
             //not used yet:
             var geojsonoption = {
             onEachFeature: function onEachFeature(feature, layer) {
             // does this feature have a property named popupContent?
             if (feature.properties && feature.properties.popupContent) {
             layer.bindPopup(feature.properties.popupContent);
             }
             },
             pointToLayer: function (feature, latlng) {
             return L.circleMarker(latlng, geojsonMarkerOptions);
             }
             };
             */

            function addFeature(id, f) {
                if (!f.geom)
                    return;
                if (features[id])
                    return;

                f.type = "Feature";
                f.geometry = f.geom;


                if (f.geom.type === "point")
                    f.geometry.type = "Point";
                
                //https://github.com/albburtsev/Leaflet.geojsonCSS
                //L.geoJson.css(json).addTo(map);
                var layer = L.geoJson(f, {
                    /*style: function (feature) {
                     return {color: feature.properties.color};
                     },*/
                    onEachFeature: function (feature, layer) {
                        layer.bindPopup(feature.description);
                    }
                });
                layer.data = f;
                features[id] = layer;
                layer.addTo(map);
            }

            function removeFeature(i) {
                features[i].removeFrom(map);
                delete features[i];
            }
            
            function newTag(layerID) {
                var t = {
                    id: layerID, 
                    name: undefined, featuresVisible: 0,
                    features: new WeakSet(),
                    inh: { }
                };

                tag.setNode(layerID, t);
                
                t.update = function() {
                    if (this.inh) {
                        //TODO remove existing edges
                        
                        _.each(this.inh, function(strength, superTag) {                            
                            var n = tag.node(superTag);
                            if (!n) {
                                newTag(superTag);                                
                            }
                                
                            tag.setEdge(superTag, layerID);
                        });
                    }
                };
                
                
                return t;
            }

            function updateGeoJSONFeatures(r) {

                _.each(tag.nodes(), function(l) {
                    var n = tag.node(l);
                    if (n)
                        n.featuresVisible = 0;
                });                
                for (var i in features) {
                    if (!r[i]) {
                        removeFeature(i);
                    }
                }

                for (var i in r) {
                    var f = r[i];
                    addFeature(i, f);
                }

                var unknownLayers = {};

                for (var i in features) {
                    var f = features[i].data;
                    var p = f.path;

                    if (!p)
                        continue;

                    //TODO cache known paths
                    
                    var parent = null;
                    var layerNode = null;
                    
                    for (var i = 0; i < p.length; i++) {
                        var layerID = p[i];
                        layerNode = tag.node(layerID);
                        
                        if (layerNode) {
                            layerNode.featuresVisible = layerNode.featuresVisible + 1;
                        }
                        else {
                            var layerNode = newTag(layerID);                            
                            layerNode.inh[parent] = 1.0;
                            layerNode.update();
                            
                            unknownLayers[layerID] = true;
                        }
                                                                        
                        parent = layerID;
                        
                        layerNode.features.add(f);
                    }
                    
                    

                }

                unknownLayers = _.map(_.keys(unknownLayers),
                        function (l) {
                            return encodeURIComponent(l);
                        });

                
                if (unknownLayers.length > 0)
                    renderTags(unknownLayers, renderLayerViews);
                else
                    renderLayerViews();
            }
            
            function renderLayerViews() {
                renderLayerView($('#visibleLayers'), tag.sources());
            }
            
            function opacityChange(x) {                
                var d = $(this).data('tag');
                var opacity = $(this).val();
                
                if (opacity < 0.01) {
                    delete tagOpacity[d];
                }
                else {
                    tagOpacity[d] = opacity;
                }
                
                setTimeout(renderTags, 0);
            }
            
            function updateTagButton(x) {                
                var d = $(this).data('tag');
                window.open("watch.html?url=tag&operation=update&channels=" + d, "_blank", "toolbar=yes, scrollbars=yes, resizable=yes, top=500, left=500, width=400, height=400");
            }

            function renderLayerView(vl, s) {
                
                vl.html('');
                             
                if (s && s.length)
                    _.each(s, function (n) {
                        if (!n) return;

                        v = tag.node(n);

                        if (!v) {
                            console.error('missing tag: ' + n);
                            return;
                        }

                        var name = v.name || v.id;
                        var count = v.featuresVisible;
                        //nu.append('<li>' + name + ' ' + count + '</li>');

                        var d = $('<li></li>');
                        
                        var a = $('<a>' + name + ' (' + count + ')</a>').appendTo(d);                        
                        
                        
                        var opacity = $('<input class="opacitySlider" type="range" min="0" step="0.01" max="1.0"/>').appendTo(a);
                        opacity.val(tagOpacity[n] || 0);
                        opacity.data('tag', n);
                        
                        opacity.change(opacityChange);
                        
                        var updateButton = $('<button>U</button>').appendTo(a);
                        updateButton.data('tag', n);
                        updateButton.click(updateTagButton);
                        
                        
                        var u  = $('<ul>').appendTo(d);

                        renderLayerView(u, tag.successors( v.id ));

                        if(count) {
                            d.addClass('enabled');
                        }

                        //d.append(JSON.stringify(layer.successors(n)));

                        vl.append(d);
                    });

            }
            
            var ajaxFail = function (v, m) {  
                console.error('AJAJ Err:', v, m);  
                
            };

            function updateLayerMetadata(r) {
                for (var i in r) {
                    var l = r[i];
                    
                    var n = tag.node(i);
                    if (!n) {
                        n = newTag(i);
                    }
                    
                    
                    //TODO copy other metadata, use _.extend
                    n.name = l.name || i;                    
                    if (l.inh) {
                        n.inh = l.inh;

                    }
                    
                    n.update();
                    
                }
            }

            function updateTagIndex(callback) {
                $.getJSON('/tag/index')
                    .done(function (r) {
                        updateLayerMetadata(r);
                        if (callback)  callback();
                    })
                    .fail(ajaxFail);
            }

            function renderTags(layerIDs, callback) {
                $.getJSON('/tag/meta', {id: JSON.stringify(layerIDs)})
                    .done(function (r) {
                        updateLayerMetadata(r);
                        if (callback)  callback();
                    })
                    .fail(ajaxFail);
            }
            

            var updateBounds = _.throttle(function (e) {
                var b = map.getBounds();

                var radiusMeters = b.getSouthEast().distanceTo(b.getNorthWest()) / 2.0;
                var lon = b.getCenter().lng;
                var lat = b.getCenter().lat;


                $.getJSON('/geoCircle', {lat: lat, lon: lon, radiusM: radiusMeters})

                        .done(function (r) {
                            //console.log(r);

                            updateGeoJSONFeatures(r);
                        })
                        .fail(function (v, m) {
                            console.log('err', v, m);
                        });
            }, updatePeriodMS);

            $(document).ready(init);

        </script>

    </body>
</html>
